<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>self-chat</title>
    <link rel="icon" href="data:;base64,=">
    <style>
        :root { --primary: #3b82f6; --bg: #f3f4f6; --text: #1f2937; }
        * { box-sizing: border-box; }
        body { max-width: 800px; margin: 0 auto; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ÁôªÂΩïÂ±Ç */
        #login-layer { position: fixed; inset: 0; background: #fff; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #login-layer input { padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; width: 220px; text-align: center; }
        #login-layer button { padding: 10px 30px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; }

        /* È°∂ÈÉ®ÂØºËà™ */
        header { padding: 10px 15px; background: #fff; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .logo { font-weight: 700; font-size: 16px; }
        .logout-btn { background: none; border: none; color: #6b7280; font-size: 12px; cursor: pointer; }

        /* --- Êñ∞Â¢ûÔºöÊéßÂà∂Áä∂ÊÄÅÊ†è --- */
        #status-bar { background: #f9fafb; padding: 8px 15px; font-size: 12px; color: #6b7280; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; }
        .status-left { display: flex; align-items: center; gap: 10px; }
        .status-right { font-family: monospace; }
        
        /* ÂºÄÂÖ≥Ê†∑Âºè */
        .toggle-label { display: flex; align-items: center; cursor: pointer; user-select: none; }
        .toggle-label input { margin-right: 5px; }
        
        /* Âà∑Êñ∞ÊåâÈíÆ */
        .refresh-icon { cursor: pointer; padding: 2px 6px; background: #e5e7eb; border-radius: 4px; margin-left: 5px; transition: 0.2s; }
        .refresh-icon:hover { background: #d1d5db; }
        .refresh-icon:active { transform: scale(0.95); }

        /* ËÅäÂ§©Âå∫Âüü */
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column-reverse; gap: 12px; }
        .msg-item { display: flex; flex-direction: column; align-items: flex-start; max-width: 88%; }
        .msg-meta { font-size: 10px; color: #9ca3af; margin-bottom: 2px; margin-left: 2px; }
        .msg-bubble { padding: 8px 12px; border-radius: 8px; background: #fff; box-shadow: 0 1px 1px rgba(0,0,0,0.05); line-height: 1.4; word-break: break-word; }

        /* ËæìÂÖ•Âå∫Âüü */
        #input-area { background: #fff; padding: 10px; border-top: 1px solid #e5e7eb; display: flex; gap: 8px; flex-shrink: 0; }
        #nick-input { width: 60px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; text-align: center; font-size: 12px; }
        #msg-input { flex: 1; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 20px; outline: none; }
        #send-btn { background: var(--primary); color: white; border: none; padding: 0 15px; border-radius: 20px; font-size: 13px; cursor: pointer; }
        #send-btn:disabled { background: #9ca3af; }
    </style>
</head>
<body>

    <div id="login-layer">
        <h2>üîí self-chat</h2>
        <input type="password" id="pwd-input" placeholder="Password">
        <button onclick="doLogin()">Login</button>
    </div>

    <div id="app" style="display:none; flex-direction: column; height: 100%;">
        <header>
            <div class="logo">self-chat</div>
            <button class="logout-btn" onclick="doLogout()">Logout</button>
        </header>

        <!-- Êñ∞Â¢ûÔºöÁä∂ÊÄÅÊéßÂà∂Ê†è -->
        <div id="status-bar">
            <div class="status-left">
                <label class="toggle-label">
                    <input type="checkbox" id="auto-mode" checked onchange="toggleMode()"> 
                    <span>Auto</span>
                </label>
                <!-- ÊâãÂä®Âà∑Êñ∞ÊåâÈíÆ -->
                <span class="refresh-icon" onclick="manualRefresh()" title="Force Refresh">‚Üª</span>
            </div>
            <div class="status-right" id="last-update">Waiting...</div>
        </div>

        <div id="chat-container"></div>

        <div id="input-area">
            <input type="text" id="nick-input" placeholder="Name" maxlength="10">
            <input type="text" id="msg-input" placeholder="Message..." maxlength="300" onkeypress="if(event.key==='Enter') sendMsg()">
            <button id="send-btn" onclick="sendMsg()">Send</button>
        </div>
    </div>

    <script>
        const API = '/api/msg';
        let token = localStorage.getItem('cf_im_token');
        let pollingInterval = null;

        // È°µÈù¢Âä†ËΩΩ
        if (token) {
            showApp();
            document.getElementById('nick-input').value = localStorage.getItem('cf_im_nick') || '';
            // ÈªòËÆ§ÂºÄÂêØËΩÆËØ¢
            toggleMode(); 
        }

        function doLogin() {
            const input = document.getElementById('pwd-input').value;
            if (input) {
                token = input;
                localStorage.setItem('cf_im_token', input);
                showApp();
                toggleMode(); // ÁôªÂΩïÂêéÂêØÂä®
            }
        }

        function doLogout() {
            localStorage.removeItem('cf_im_token');
            location.reload();
        }

        function showApp() {
            document.getElementById('login-layer').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
        }

        // --- Êñ∞Â¢ûÔºöÊ®°ÂºèÂàáÊç¢ÈÄªËæë ---
        function toggleMode() {
            const isAuto = document.getElementById('auto-mode').checked;
            
            if (isAuto) {
                // Â¶ÇÊûúÊòØËá™Âä®Ê®°ÂºèÔºöÁ´ãÂç≥ÊãâÂèñ‰∏ÄÊ¨°ÔºåÁÑ∂ÂêéÊØè5ÁßíÊãâ‰∏ÄÊ¨°
                fetchMsgs();
                if (!pollingInterval) {
                    pollingInterval = setInterval(fetchMsgs, 5000);
                }
            } else {
                // Â¶ÇÊûúÊòØÊâãÂä®Ê®°ÂºèÔºöÊ∏ÖÈô§ÂÆöÊó∂Âô®
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
            }
        }

        // --- Êñ∞Â¢ûÔºöÊâãÂä®Âà∑Êñ∞ ---
        function manualRefresh() {
            // Áªô‰∏™Â∞èÂèçÈ¶àÔºåËÆ©ÊñáÂ≠óÈó™‰∏Ä‰∏ã
            const statusTxt = document.getElementById('last-update');
            statusTxt.style.opacity = '0.5';
            fetchMsgs().then(() => {
                statusTxt.style.opacity = '1';
            });
        }

        // Ê†∏ÂøÉÊãâÂèñ
        async function fetchMsgs() {
            if (!token) return;
            try {
                const res = await fetch(API, { headers: { 'x-auth-token': token } });
                
                if (res.status === 401) {
                    alert("Session expired");
                    doLogout();
                    return;
                }
                if (!res.ok) return;

                const list = await res.json();
                if (Array.isArray(list)) {
                    render(list);
                    // --- Êõ¥Êñ∞Êó∂Èó¥Êà≥ ---
                    const now = new Date();
                    const timeStr = now.toTimeString().split(' ')[0]; // "11:25:30"
                    document.getElementById('last-update').innerText = `Updated: ${timeStr}`;
                }
            } catch (e) { console.error(e); }
        }

        async function sendMsg() {
            const msgInput = document.getElementById('msg-input');
            const nickInput = document.getElementById('nick-input');
            const btn = document.getElementById('send-btn');
            
            const content = msgInput.value.trim();
            const nickname = nickInput.value.trim();
            if (!content) return;

            if (nickname) localStorage.setItem('cf_im_nick', nickname);

            btn.disabled = true;
            try {
                await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                    body: JSON.stringify({ content, nickname })
                });
                msgInput.value = '';
                await fetchMsgs(); 
            } catch (e) { alert("Failed"); } 
            finally { btn.disabled = false; msgInput.focus(); }
        }

        function render(data) {
            const box = document.getElementById('chat-container');
            const html = data.map(item => `
                <div class="msg-item">
                    <div class="msg-meta">
                        <strong>${esc(item.user)}</strong> ¬∑ ${new Date(item.ts).toLocaleTimeString()}
                    </div>
                    <div class="msg-bubble">${esc(item.text)}</div>
                </div>
            `).join('');
            if (box.innerHTML !== html) box.innerHTML = html;
        }

        function esc(str) { return str ? str.replace(/&/g, "&amp;").replace(/</g, "&lt;") : ''; }
    </script>
</body>
</html>